# Mini CRM - Система распределения лидов между операторами

Мини-CRM система для автоматического распределения обращений лидов между операторами с учётом их загрузки и весовых коэффициентов по источникам.

## Технологический стек

- **Язык**: Python 3.12+
- **Web-фреймворк**: FastAPI
- **ORM**: SQLAlchemy (async)
- **База данных**: SQLite (файловая)

## Запуск проекта

### Установка зависимостей

Проект использует Poetry для управления зависимостями:

```bash
poetry install
```

### Запуск сервера

```bash
poetry run uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

Или напрямую через Python:

```bash
poetry run python main.py
```

Сервер будет доступен по адресу: `http://localhost:8000`

### Документация API

После запуска сервера доступна интерактивная документация:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Модель данных

Система состоит из следующих основных сущностей:

### 1. **Lead (Лид)**
Представляет конечного клиента.
- `id` - уникальный идентификатор
- `external_id` - внешний идентификатор лида (уникальный, используется для определения одного и того же лида)
- `created_at` - дата создания
- `interactions` - список обращений лида

**Связи:**
- Один лид может иметь множество обращений (`Interaction`)

### 2. **Operator (Оператор)**
Представляет оператора, который обрабатывает обращения.
- `id` - уникальный идентификатор
- `name` - имя оператора
- `is_active` - флаг активности (может ли получать новые обращения)
- `limit` - лимит по максимальному количеству активных обращений
- `interactions` - список назначенных обращений
- `source_configs` - конфигурации по источникам (веса)

**Связи:**
- Один оператор может иметь множество обращений (`Interaction`)
- Один оператор может быть настроен для множества источников через `SourceOperator`

### 3. **Source (Источник/Бот)**
Представляет канал, из которого пришло обращение.
- `id` - уникальный идентификатор
- `name` - название источника (уникальное)
- `operator_configs` - конфигурации операторов для этого источника (веса)
- `interactions` - список обращений из этого источника

**Связи:**
- Один источник может иметь множество обращений (`Interaction`)
- Один источник может быть настроен для множества операторов через `SourceOperator`

### 4. **SourceOperator (Конфигурация распределения)**
Связующая таблица между источниками и операторами, хранящая веса распределения.
- `id` - уникальный идентификатор
- `source_id` - идентификатор источника
- `operator_id` - идентификатор оператора
- `weight` - числовой вес оператора для данного источника

**Особенности:**
- Уникальное ограничение на пару `(source_id, operator_id)`
- Вес определяет долю трафика, которую должен получать оператор

### 5. **Interaction (Обращение/Контакт)**
Конкретный факт обращения лида из определённого источника.
- `id` - уникальный идентификатор
- `created_at` - дата создания обращения
- `lead_id` - идентификатор лида
- `source_id` - идентификатор источника
- `operator_id` - идентификатор назначенного оператора (может быть `NULL`)
- `is_active` - флаг активности обращения (используется для подсчёта нагрузки)

**Связи:**
- Принадлежит одному лиду (`Lead`)
- Принадлежит одному источнику (`Source`)
- Может быть назначено одному оператору (`Operator`) или остаться без оператора

## Алгоритм распределения обращений

### 1. Определение лида

При создании нового обращения система:
- Ищет существующего лида по `external_id`
- Если лид не найден - создаёт нового
- Используется поле `external_id` для однозначной идентификации одного и того же лида

### 2. Определение доступных операторов для источника

Система находит всех операторов, которые:
- Назначены на данный источник в конфигурации (`SourceOperator`)
- Активны (`is_active = True`)
- Не превышают лимит нагрузки: количество активных обращений (`is_active = True`) < `limit`

**Нагрузка оператора** определяется как количество активных обращений (`Interaction` с `is_active = True`), назначенных данному оператору.

### 3. Распределение с учётом весов

Реализован алгоритм **Weighted Round-Robin** (детерминированный):

1. Для каждого доступного оператора вычисляется **score**:
   ```
   score = current_load / weight
   ```
   где:
   - `current_load` - текущее количество активных обращений оператора
   - `weight` - вес оператора для данного источника

2. Выбирается оператор с **минимальным score** (наименее загруженный относительно своего веса)

3. Это обеспечивает распределение, при котором в среднем доля обращений соответствует весам:
   - Оператор с большим весом получает больше обращений
   - Оператор с меньшим весом получает меньше обращений
   - При равных весах нагрузка распределяется равномерно

**Пример:**
- Оператор 1: вес = 10, нагрузка = 2 → score = 0.2
- Оператор 2: вес = 30, нагрузка = 5 → score = 0.167
- Выбирается Оператор 2 (минимальный score)

### 4. Создание обращения

Система создаёт обращение (`Interaction`) и связывает его с:
- Лидом (найденным или созданным)
- Источником
- Назначенным оператором (если найден подходящий)

## Обработка отсутствия доступных операторов

Если подходящих операторов нет (все неактивны или превысили лимит), система:
- **Создаёт обращение без оператора** (`operator_id = NULL`)
- Возвращает успешный ответ с информацией об обращении
- Обращение сохраняется в системе и может быть обработано позже (например, при освобождении операторов или изменении их статуса)

Это позволяет не терять обращения и даёт возможность обработать их вручную или автоматически при появлении доступных операторов.

## API Endpoints

### Управление операторами

- `POST /operators/` - создание оператора
- `GET /operators/` - список всех операторов
- `PATCH /operators/{operator_id}` - обновление оператора (активность, лимит, имя)

### Регистрация обращений

- `POST /interactions` - регистрация нового обращения
  - Тело запроса:
    ```json
    {
      "external_lead_id": "lead_123",
      "source_id": 1
    }
    ```
  - Возвращает информацию об обращении и назначенном операторе (если есть)

### Healthcheck

- `GET /health` - проверка работоспособности сервера

## Структура проекта

```
CRM/
├── api/                    # API endpoints
│   └── views/             # Роутеры для различных сущностей
├── core/                   # Ядро приложения
│   ├── config.py          # Конфигурация
│   ├── database.py        # Настройка БД
│   ├── models/            # SQLAlchemy модели
│   ├── repository/        # Репозитории для работы с БД
│   ├── schemas/           # Pydantic схемы
│   └── services/          # Бизнес-логика
├── main.py                # Точка входа приложения
└── pyproject.toml         # Зависимости проекта
```

## Особенности реализации

- Используется async/await для всех операций с БД
- Автоматическое создание и удаление таблиц при старте/остановке приложения (для разработки)
- База данных SQLite хранится в файле `crm.db` (по умолчанию)
- Все модели наследуются от базового класса с полями `id` и `created_at`

## Дальнейшее развитие

Возможные улучшения:
- Добавление эндпоинтов для управления источниками и их конфигурацией
- Добавление эндпоинтов для просмотра статистики распределения
- Реализация механизма перераспределения обращений без оператора
- Добавление миграций БД (Alembic)
- Добавление тестов
- Docker-контейнеризация

